/*!
 * Lady
 *
 * Lady is an asynchronous document.write deferrer. It can be used to defer
 * loading of normally blocking ads, render document.writes in AJAX responses.
 * Lady uses DOM manipulation techniques to provide support for complex
 * scenarios, such as recursively included scripts.
 *
 * @version 1.0beta
 * @author Markably
 * @link http://www.markably.com
 * @copyright (c) Markably
 */
;(function(d,a){function c(){this._jobs=[]}c.prototype.add=function(e){this._jobs.push(e);return this};c.prototype.flush=function(e){if(0===this.length()){e&&e()}else{this._jobs.shift()((function(f){return function(){f.flush(e)}}(this)))}};c.prototype.length=function(){return this._jobs.length};function b(){this._queue=new c();this._write=a.write}b.prototype.capture=function(){a.write=a.writeln=(function(e){return function(f){var g=e._id();e.defer({id:g,data:f})._write.call(this,'<span class="lady-capture" id="'+g+'"></span>')}}(this));return this};b.prototype.defer=function(f){var h=f.id||this._id(),g,e=f.fn||function(){};if(f.url){g='<script src="'+f.url+'"><\/script>'}else{g="function"===typeof f.data?"<script>("+f.data+").call(window);<\/script>":f.data}this._queue.add((function(i){return function(j){var k=a.getElementById(h)||null;if(null!==k){if(k.classList){k.classList.add("lady")}else{if(!k.className.match(/(\s|^)lady(\s|$)/)){k.className+=(k.className?" ":"")+"lady"}}}else{k=a.createElement("span");k.className="lady lady-mock";k.id=h;(a.body||a.getElementsByTagName("body")[0]).appendChild(k)}i._render(g,k,function(){e&&e(k);j&&j()})}}(this)));return this};b.prototype.render=function(e){this._queue.flush(e)};b.prototype._eval=function(e){(d.execScript||function(f){d["eval"].call(d,f)})(e)};b.prototype._id=(function(){var e=0;return function(){return"__"+(e+=1)+"_"+new Date().getTime()}}());b.prototype._inject=function(k,l,j){var h,g,e=new c(),f=function(i,m,n){e.add(function(o){i._inject(m,n,o)})};if("script"===k.nodeName.toLowerCase()){e.add((function(i){return function(m){i._injectScript(k,l,m)}}(this)))}else{g=k.cloneNode(false);l.appendChild(g);for(h=0;h<k.childNodes.length;h+=1){f(this,k.childNodes[h],g)}}e.flush(j)};b.prototype._injectScript=function(g,h,f){var e=new c();a.write=a.writeln=(function(i){return function(j){e.add(function(k){i._render(j,h,k)})}}(this));if((g.hasAttribute&&g.hasAttribute("src"))||g.src){this._load(g.getAttribute("src"),function(){e.flush(f)})}else{this._eval(g.textContent||g.innerHTML);e.flush(f)}};b.prototype._load=function(f,h){var g=a.head||a.getElementsByTagName("head")[0],e=a.createElement("script");e.setAttribute("src",f);e.setAttribute("async","async");e.onreadystatechange=function(){var i=this.readyState.toLowerCase();if("complete"===i||"loaded"===i){this.onload();this.onerror=this.onload=this.onreadystatechange=null}};e.onerror=e.onload=function(){g.removeChild(this);h&&h()};g.appendChild(e)};b.prototype._render=function(k,l,h){var j=this._stringToDOM(k),g,e=new c(),f=function(i,m){e.add(function(n){i._inject(m,l,n)})};for(g=0;g<j.length;g+=1){f(this,j[g])}e.flush(h)};b.prototype._stringToDOM=function(f){f='<input type="hidden" />'+f;var e=a.createElement("div");e.innerHTML=f;e.removeChild(e.childNodes[0]);return e.childNodes};d.Lady=b}(window,document));