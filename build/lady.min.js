/*!
 * Lady
 *
 * Lady is an asynchronous document.write deferrer. It can be used to defer
 * loading of otherwise blocking ads or render document.writes in AJAX responses.
 * Lady uses DOM manipulation techniques to provide support for complex
 * scenarios, such as recursively nested scripts and speculative parsing.
 * No external library is required, and no eval is used. The resulting code
 * is exactly the same as before, only all is done asynchronously.
 *
 * @version v1.0dev
 * @author Markably
 * @link http://www.markably.com
 * @copyright (c) Markably
 */
;(function(d,a){function c(e){this._instant="undefined"===typeof e||e||false;this._jobs=[];this._pending=0}c.prototype.add=function(f){this._jobs.push(f);if(this._instant){this._pending+=1;if(1===this._pending){var e=(function(g){return function(){g._pending-=1;if(0<g._pending){g._jobs.shift()(e)}}}(this));this._jobs.shift()(e)}}return this};c.prototype.flush=function(e){if(this._instant){e&&this.add(function(f){f&&f();e&&e()});return}if(0===this._jobs.length){e&&e()}else{this._jobs.shift()((function(f){return function(){f.flush(e)}}(this)))}};c.prototype.length=function(){return this._jobs.length};function b(){this._document={close:a.close,open:a.open,write:a.write,writeln:a.writeln};this._queue=new c(false)}b.prototype.capture=function(){var e="",g=0,f;a.close=(function(h){return function(){g-=1;if(0===g){h._defer({id:f,data:e});e=""}}}(this));a.open=(function(h){return function(){g+=1;if(1===g){f=h._id();h._document.write.call(this,'<span class="lady-capture" id="'+f+'"></span>')}}}(this));a.write=(function(h){return function(){e+=[].concat.apply([],arguments).join("");if(0===g){var i=h._id();h.defer({id:i,data:e})._document.write.call(this,'<span class="lady-capture" id="'+i+'"></span>');e=""}}}(this));a.writeln=function(){a.write([].concat.apply([],arguments).join("\n")+"\n")};return this};b.prototype.defer=function(f){var h=f.id||this._id(),g,e=f.fn||function(){};if(f.url){g='<script src="'+f.url+'"><\/script>'}else{g="function"===typeof f.data?"<script>("+f.data+").call(window);<\/script>":f.data}this._queue.add((function(i){return function(j){var k=a.getElementById(h)||null;if(null===k){k=a.createElement("span");k.className="lady-mock";k.id=h;a.body.appendChild(k)}if(k.classList){k.classList.add("lady")}else{k.className+=" lady"}i._render(g,k,function(){j&&j();e&&e(k)})}}(this)));return this};b.prototype.render=function(e){this._queue.flush(e)};b.prototype.restore=function(){a.close=this._document.close;a.open=this._document.open;a.write=this._document.write;a.writeln=this._document.writeln;return this};b.prototype._id=(function(){var e=0;return function(){return"lady-"+(e+=1)+"-"+new Date().getTime()}}());b.prototype._import=function(h,e){e="undefined"===typeof e||e||false;if(a.implementation.createHTMLDocument&&a.createRange&&a.createRange().createContextualFragment){return a.importNode(h,e)}switch(h.nodeType){case a.ELEMENT_NODE||1:var g,f=h.cloneNode(false);if((f.hasAttribute&&f.hasAttribute("_src"))||f._src){f.setAttribute("src",f.getAttribute("_src"));f.removeAttribute("_src")}if((f.hasAttribute&&f.hasAttribute("_value"))||f._value){f.setAttribute("value",f.getAttribute("_value"));f.removeAttribute("_value")}if("script"===h.nodeName.toLowerCase()){f.text=h.text&&h.text.replace(/_(src|value)=/g,"$1=")}else{if(e){for(g=0;g<h.childNodes.length;g+=1){f.appendChild(this._import(h.childNodes.item(g),e))}}}return f;case a.TEXT_NODE||3:return a.createTextNode(h.nodeValue.replace(/_(src|value)=/g,"$1="));case a.CDATA_SECTION_NODE||4:return a.createCDATASection(h.nodeValue.replace(/_(src|value)=/g,"$1="));case a.COMMENT_NODE||8:return a.createComment(h.nodeValue.replace(/_(src|value)=/g,"$1="));default:return a.createTextNode("")}};b.prototype._inject=function(l,m,k){var j=this,h,g,e=new c(),f=function(i,n,o){e.add(function(p){i._inject(n,o,p)})};if("script"===l.nodeName.toLowerCase()){e.add(function(i){j._injectScript(l,m,i)})}else{g=this._import(l,false);m.appendChild(g);for(h=0;h<l.childNodes.length;h+=1){f(this,l.childNodes.item(h),g)}}e.flush(k)};b.prototype._injectScript=function(f,i,k){var e=this,l=this._import(f,true),h=new c(),g="",n=0,m={open:a.open,close:a.close,write:a.write,writeln:a.writeln},j=function(){a.close=m.close;a.open=m.open;a.write=m.write;a.writeln=m.writeln};a.close=function(){n-=1;if(0===n){(function(o){h.add(function(p){e._render(o,i,p)})}(g));g=""}};a.open=function(){n+=1};a.write=function(){g+=[].concat.apply([],arguments).join("");if(0===n&&e._validate(g)){(function(o){h.add(function(p){e._render(o,i,p)})}(g));g=""}};a.writeln=function(){a.write([].concat.apply([],arguments).join("\n")+"\n")};if((l.hasAttribute&&l.hasAttribute("src"))||l.src){if("undefined"===typeof l.onload){l.onreadystatechange=function(){var o=this.readyState.toLowerCase();if("complete"===o||"loaded"===o){this.onload();this.onreadystatechange=null}}}l.onerror=l.onload=function(){if(""!==g){h.add(function(o){e._render(g,i,o)})}h.flush(function(){j&&j();k&&k()})};i.appendChild(l)}else{if(false===l.async){d["eval"].call(d,l.text);l.text=""}i.appendChild(l);if(""!==g){h.add(function(o){e._render(g,i,o)})}h.flush(function(){j&&j();k&&k()})}};b.prototype._render=function(l,k,h){var j=this._tokenize(l),g,e=new c(),f=function(i,m){e.add(function(n){i._inject(m,k,n)})};for(g=0;g<j.length;g+=1){f(this,j.item(g))}e.flush(h)};b.prototype._tokenize=function(h){var g,e,f;if(a.implementation.createHTMLDocument&&a.createRange&&a.createRange().createContextualFragment){g=a.implementation.createHTMLDocument("tokenizer");e=g.createElement("div");f=g.createRange();g.body.appendChild(e);f.selectNode(e);return f.createContextualFragment(h).childNodes}e=a.createElement("div");e.innerHTML='<input type="hidden" />'+h.replace(/ (src|value)=/g," _$1=");e.removeChild(e.childNodes.item(0));return e.childNodes};b.prototype._validate=function(g){var e=g.match(/<\w+(?:(?:\s+\w+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^'">\s]+))?)+\s*|\s*)>/,g),f=g.match(/<\/\w+\s*>/,g);return e===f||(e&&f&&e.length===f.length)};d.Lady=b}(window,document));