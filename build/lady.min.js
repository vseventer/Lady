/*!
 * Lady
 *
 * Lady is an asynchronous document.write deferrer. It can be used to defer
 * loading of otherwise blocking ads or render document.writes in AJAX responses.
 * Lady uses DOM manipulation techniques to provide support for complex
 * scenarios, such as recursively nested scripts and speculative parsing.
 * No external library is required, and no eval is used. The resulting code
 * is exactly the same as before, only all is done asynchronously.
 *
 * @version v1.0dev
 * @author Markably
 * @link http://www.markably.com
 * @copyright (c) Markably
 */
;(function(d,a){function c(e){this._instant="undefined"===typeof e||e||false;this._jobs=[];this._pending=0}c.prototype.add=function(f){this._jobs.push(f);if(this._instant){this._pending+=1;if(1===this._pending){var e=(function(g){return function(){g._pending-=1;if(0<g._pending){g._jobs.shift()(e)}}}(this));this._jobs.shift()(e)}}return this};c.prototype.flush=function(e){if(this._instant){e&&this.add(function(f){f&&f();e&&e()});return}if(0===this._jobs.length){e&&e()}else{this._jobs.shift()((function(f){return function(){f.flush(e)}}(this)))}};c.prototype.length=function(){return this._jobs.length};function b(){this._document={close:a.close,open:a.open,write:a.write,writeln:a.writeln};this._loaded=false;this._stack=[new c(false)];this._target=[];var e=(function(f){return function(){f._loaded=true}}(this));if(a.addEventListener){a.addEventListener("DOMContentLoaded",e,false)}else{a.onreadystatechange=function(){if(this.readyState.match(/interactive|complete/)){this.onreadystatechange=null;e()}}}}b.prototype.defer=function(e,f){if("object"!==typeof e){e={data:e,fn:f}}e.data=e.html||("string"===typeof e.data?'<script src="'+e.data+'"><\/script>':"<script>("+e.data+").call(window);<\/script>");e.target=e.target||this._mock();this._stack[0].add((function(g){return function(h){g._stack.unshift(new c(false));if("object"!==typeof e.target){e.target=a.getElementById(e.target);if(!e.target){e.target=a.createElement("span");e.target.className="lady-mock";a.body.appendChild(e.target)}}if(e.target.classList){e.target.classList.add("lady")}else{if(!e.target.className.match(/(?:^|\s)lady(?:\s|$)/)){e.target.className+=(""!==e.target.className?" ":"")+"lady"}}g._render(e.data,e.target,function(){g._stack.shift().flush(function(){e.fn&&e.fn(e.target);h&&h()})})}}(this)));return this};b.prototype.parse=function(e,g){if("object"!==typeof e){e={html:e,fn:g}}var f=function(h){if((h.hasAttribute&&h.hasAttribute("src"))||h.src){h.setAttribute("data-lady-src",h.getAttribute("src"));h.removeAttribute("src")}else{if(""!==h.text){h.setAttribute("data-lady-text",h.text);h.text=""}}};return this.defer({fn:function(k){var j,h=k.getElementsByTagName("script");for(j=0;j<h.length;j+=1){f(h[j])}e.fn&&e.fn(k)},html:e.html,target:e.target})};b.prototype.render=function(e){this._stack[0].flush(e)};b.prototype._import=function(h,e){e="undefined"===typeof e||e||false;if(a.implementation.createHTMLDocument&&a.createRange&&a.createRange().createContextualFragment){return a.importNode(h,e)}switch(h.nodeType){case a.ELEMENT_NODE||1:var g,f=h.cloneNode(false);if((f.hasAttribute&&f.hasAttribute("_src"))||f._src){f.setAttribute("src",f.getAttribute("_src"));f.removeAttribute("_src")}if((f.hasAttribute&&f.hasAttribute("_value"))||f._value){f.setAttribute("value",f.getAttribute("_value"));f.removeAttribute("_value")}if("script"===h.nodeName.toLowerCase()){f.text=h.text&&h.text.replace(/_(src|value)=/g,"$1=")}else{if(e){for(g=0;g<h.childNodes.length;g+=1){f.appendChild(this._import(h.childNodes.item(g),e))}}}return f;case a.TEXT_NODE||3:return a.createTextNode(h.nodeValue.replace(/_(src|value)=/g,"$1="));case a.CDATA_SECTION_NODE||4:return a.createCDATASection(h.nodeValue.replace(/_(src|value)=/g,"$1="));case a.COMMENT_NODE||8:return a.createComment(h.nodeValue.replace(/_(src|value)=/g,"$1="));default:return a.createTextNode("")}};b.prototype._inject=function(l,m,k){var j=this,h,g,e=new c(),f=function(i,n,o){e.add(function(p){i._inject(n,o,p)})};if("script"===l.nodeName.toLowerCase()){e.add(function(i){j._injectScript(l,m,i)})}else{if((a.ELEMENT_NODE||1)===l.nodeType&&!l.getElementsByTagName("script").length){m.appendChild(this._import(l))}else{g=this._import(l,false);m.appendChild(g);for(h=0;h<l.childNodes.length;h+=1){f(this,l.childNodes.item(h),g)}}}e.flush(k)};b.prototype._injectScript=function(f,i,k){var e=this,l=this._import(f,true),h=new c(),g="",n=0,m={open:a.open,close:a.close,write:a.write,writeln:a.writeln},j=function(){a.close=m.close;a.open=m.open;a.write=m.write;a.writeln=m.writeln;e._target.shift()};a.close=function(){n-=1;if(0===n){(function(o){h.add(function(p){e._render(o,i,p)})}(g));g=""}};a.open=function(){n+=1};a.write=function(){g+=[].slice.call(arguments,0).join("");if(0===n&&e._validate(g)){(function(o){h.add(function(p){e._render(o,i,p)})}(g));g=""}};a.writeln=function(){a.write([].slice.call(arguments,0).join("\n")+"\n")};this._target.unshift(i);if((l.hasAttribute&&l.hasAttribute("src"))||l.src){if("undefined"===typeof l.onload){l.onreadystatechange=function(){var o=this.readyState.toLowerCase();if("complete"===o||"loaded"===o){this.onload();this.onreadystatechange=null}}}l.onerror=l.onload=function(){if(""!==g){h.add(function(o){e._render(g,i,o)})}h.flush(function(){j&&j();k&&k()})};i.appendChild(l)}else{if(false===l.async){d["eval"].call(d,l.text);l.text=""}i.appendChild(l);if(""!==g){h.add(function(o){e._render(g,i,o)})}h.flush(function(){j&&j();k&&k()})}};b.prototype._mock=function(){if(this._target[0]){return this._target[0]}var e;if(this._loaded){e=a.createElement("span");a.body.appendChild(e)}else{if(!a.body){return a.head||a.getElementsByTagName("head")[0]}else{this._document.write.call(a,'<span id="__lady"></span>');e=a.getElementById("__lady");e.removeAttribute("id")}}e.className="lady-mock lady";return e};b.prototype._render=function(l,k,h){var j=this._tokenize(l),g,e=new c(),f=function(i,m){e.add(function(n){i._inject(m,k,n)})};for(g=0;g<j.length;g+=1){f(this,j.item(g))}e.flush(h)};b.prototype._tokenize=function(h){var g,e,f;if(a.implementation.createHTMLDocument&&a.createRange&&a.createRange().createContextualFragment){g=a.implementation.createHTMLDocument("tokenizer");e=g.createElement("div");f=g.createRange();g.body.appendChild(e);f.selectNode(e);return f.createContextualFragment(h).childNodes}e=a.createElement("div");e.innerHTML='<input type="hidden" />'+h.replace(/ (src|value)=/g," _$1=");e.removeChild(e.firstChild);return e.childNodes};b.prototype._validate=function(g){var e=g.match(/<\w+(?:(?:\s+\w+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^'">\s]+))?)+\s*|\s*)>/,g),f=g.match(/<\/\w+\s*>/,g);return e===f||(e&&f&&e.length===f.length)};d.Lady=b}(window,document));